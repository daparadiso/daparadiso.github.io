<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>True Random Spotify Shuffler</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Lucide icons as SVG components
        const Music = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M9 18V5l12-2v13"></path>
                <circle cx="6" cy="18" r="3"></circle>
                <circle cx="18" cy="16" r="3"></circle>
            </svg>
        );

        const Shuffle = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="16 3 21 3 21 8"></polyline>
                <line x1="4" y1="20" x2="21" y2="3"></line>
                <polyline points="21 16 21 21 16 21"></polyline>
                <line x1="15" y1="15" x2="21" y2="21"></line>
                <line x1="4" y1="4" x2="9" y2="9"></line>
            </svg>
        );

        const AlertCircle = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
        );

        const SpotifyShuffler = () => {
            const [accessToken, setAccessToken] = useState('');
            const [currentTrack, setCurrentTrack] = useState(null);
            const [playlist, setPlaylist] = useState(null);
            const [status, setStatus] = useState('');
            const [error, setError] = useState('');
            const [isShuffling, setIsShuffling] = useState(false);

            const CLIENT_ID = '419b1c77086f46419ef6dda98c2bfcfd';
            const REDIRECT_URI = window.location.href.split('?')[0].split('#')[0];
            const SCOPES = [
                'user-read-playback-state',
                'user-modify-playback-state',
                'user-read-currently-playing',
                'playlist-read-private',
                'playlist-read-collaborative',
                'user-library-read'
            ].join(' ');

            // PKCE helper functions
            const generateRandomString = (length) => {
                const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                const values = crypto.getRandomValues(new Uint8Array(length));
                return values.reduce((acc, x) => acc + possible[x % possible.length], "");
            };

            const sha256 = async (plain) => {
                const encoder = new TextEncoder();
                const data = encoder.encode(plain);
                return window.crypto.subtle.digest('SHA-256', data);
            };

            const base64encode = (input) => {
                return btoa(String.fromCharCode(...new Uint8Array(input)))
                    .replace(/=/g, '')
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_');
            };

            useEffect(() => {
                // Check for authorization code in URL
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                
                if (code) {
                    const codeVerifier = localStorage.getItem('code_verifier');
                    if (codeVerifier) {
                        exchangeCodeForToken(code, codeVerifier);
                    }
                } else {
                    // Check for existing token
                    const token = localStorage.getItem('spotify_access_token');
                    const expiry = localStorage.getItem('spotify_token_expiry');
                    
                    if (token && expiry && Date.now() < parseInt(expiry)) {
                        setAccessToken(token);
                    }
                }
            }, []);

            const exchangeCodeForToken = async (code, codeVerifier) => {
                const payload = {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        client_id: CLIENT_ID,
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: REDIRECT_URI,
                        code_verifier: codeVerifier,
                    }),
                };

                try {
                    const response = await fetch('https://accounts.spotify.com/api/token', payload);
                    const data = await response.json();
                    
                    if (data.access_token) {
                        const expiry = Date.now() + (data.expires_in * 1000);
                        localStorage.setItem('spotify_access_token', data.access_token);
                        localStorage.setItem('spotify_token_expiry', expiry.toString());
                        localStorage.removeItem('code_verifier');
                        
                        setAccessToken(data.access_token);
                        window.history.replaceState({}, document.title, REDIRECT_URI);
                    }
                } catch (err) {
                    setError('Failed to get access token: ' + err.message);
                }
            };

            const handleLogin = async () => {
                const codeVerifier = generateRandomString(64);
                const hashed = await sha256(codeVerifier);
                const codeChallenge = base64encode(hashed);

                localStorage.setItem('code_verifier', codeVerifier);

                const authUrl = new URL('https://accounts.spotify.com/authorize');
                const params = {
                    response_type: 'code',
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    code_challenge_method: 'S256',
                    code_challenge: codeChallenge,
                    redirect_uri: REDIRECT_URI,
                };

                authUrl.search = new URLSearchParams(params).toString();
                window.location.href = authUrl.toString();
            };

            const handleLogout = () => {
                localStorage.removeItem('spotify_access_token');
                localStorage.removeItem('spotify_token_expiry');
                setAccessToken('');
                setCurrentTrack(null);
                setPlaylist(null);
            };

            const getCurrentPlayback = async () => {
                try {
                    const response = await fetch('https://api.spotify.com/v1/me/player', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });

                    if (response.status === 204) {
                        setError('No active playback found. Please start playing something on Spotify.');
                        return null;
                    }

                    if (response.status === 401) {
                        setError('Token expired. Please log in again.');
                        handleLogout();
                        return null;
                    }

                    if (!response.ok) throw new Error('Failed to get playback state');

                    const data = await response.json();
                    setCurrentTrack(data.item);
                    
                    if (data.context && data.context.type === 'playlist') {
                        return { type: 'playlist', id: data.context.uri.split(':')[2] };
                    } else if (data.context && data.context.type === 'collection') {
                        return { type: 'liked', id: 'liked' };
                    } else if (!data.context) {
                        // No context might mean Liked Songs on some clients
                        return { type: 'liked', id: 'liked' };
                    } else {
                        setError('You are not currently playing from a playlist or Liked Songs.');
                        return null;
                    }
                } catch (err) {
                    setError('Error getting playback: ' + err.message);
                    return null;
                }
            };

            const getLikedSongs = async () => {
                try {
                    let allTracks = [];
                    let url = 'https://api.spotify.com/v1/me/tracks?limit=50';

                    while (url) {
                        const response = await fetch(url, {
                            headers: { 'Authorization': `Bearer ${accessToken}` }
                        });

                        if (!response.ok) throw new Error('Failed to get liked songs');

                        const data = await response.json();
                        allTracks = [...allTracks, ...data.items.filter(item => item.track && item.track.uri)];
                        url = data.next;
                    }

                    return {
                        name: 'Liked Songs',
                        tracks: allTracks.map(item => item.track)
                    };
                } catch (err) {
                    setError('Error getting liked songs: ' + err.message);
                    return null;
                }
            };

            const getPlaylistTracks = async (playlistId) => {
                try {
                    let allTracks = [];
                    let url = `https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=50`;

                    while (url) {
                        const response = await fetch(url, {
                            headers: { 'Authorization': `Bearer ${accessToken}` }
                        });

                        if (!response.ok) throw new Error('Failed to get playlist tracks');

                        const data = await response.json();
                        allTracks = [...allTracks, ...data.items.filter(item => item.track && item.track.uri)];
                        url = data.next;
                    }

                    const playlistResponse = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}`, {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    const playlistData = await playlistResponse.json();

                    return {
                        name: playlistData.name,
                        tracks: allTracks.map(item => item.track)
                    };
                } catch (err) {
                    setError('Error getting playlist: ' + err.message);
                    return null;
                }
            };

            const fisherYatesShuffle = (array) => {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            };

            const addToQueue = async (trackUri) => {
                const response = await fetch(`https://api.spotify.com/v1/me/player/queue?uri=${encodeURIComponent(trackUri)}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (!response.ok) throw new Error('Failed to add track to queue');
            };

            const handleShuffle = async () => {
                setIsShuffling(true);
                setError('');
                setStatus('Getting current playback...');

                try {
                    const playbackInfo = await getCurrentPlayback();
                    if (!playbackInfo) {
                        setIsShuffling(false);
                        return;
                    }

                    setStatus('Fetching tracks...');
                    let playlistData;
                    
                    if (playbackInfo.type === 'liked') {
                        playlistData = await getLikedSongs();
                    } else {
                        playlistData = await getPlaylistTracks(playbackInfo.id);
                    }
                    
                    if (!playlistData) {
                        setIsShuffling(false);
                        return;
                    }

                    setPlaylist(playlistData);
                    setStatus(`Shuffling ${playlistData.tracks.length} tracks...`);

                    const shuffledTracks = fisherYatesShuffle(playlistData.tracks);

                    setStatus('Adding tracks to queue...');
                    for (let i = 0; i < shuffledTracks.length; i++) {
                        await addToQueue(shuffledTracks[i].uri);
                        setStatus(`Added ${i + 1}/${shuffledTracks.length} tracks to queue`);
                        
                        if (i % 10 === 0 && i > 0) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                    }

                    setStatus(`âœ“ Successfully shuffled ${shuffledTracks.length} tracks from "${playlistData.name}"!`);
                } catch (err) {
                    setError('Error during shuffle: ' + err.message);
                } finally {
                    setIsShuffling(false);
                }
            };

            if (!accessToken) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-green-900 via-black to-green-900 flex items-center justify-center p-4">
                        <div className="bg-gray-900 rounded-lg p-8 max-w-md w-full shadow-2xl">
                            <div className="flex items-center justify-center mb-6">
                                <div className="w-16 h-16 text-green-500"><Music /></div>
                            </div>
                            <h1 className="text-3xl font-bold text-white text-center mb-4">
                                True Random Shuffler
                            </h1>
                            <p className="text-gray-300 text-center mb-6">
                                Fix Spotify's shuffle algorithm with true randomization
                            </p>
                            
                            <div className="bg-yellow-900/30 border border-yellow-600 rounded p-4 mb-6">
                                <div className="flex gap-2">
                                    <div className="w-5 h-5 text-yellow-500 flex-shrink-0 mt-0.5"><AlertCircle /></div>
                                    <div className="text-sm text-yellow-200">
                                        <p className="font-semibold mb-2">Setup Required:</p>
                                        <ol className="list-decimal list-inside space-y-1 text-xs">
                                            <li>Go to <a href="https://developer.spotify.com/dashboard" target="_blank" rel="noopener noreferrer" className="underline">developer.spotify.com/dashboard</a></li>
                                            <li>Edit your app settings</li>
                                            <li>Add this page's exact URL to "Redirect URIs"</li>
                                            <li>Save and come back here</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>

                            <button
                                onClick={handleLogin}
                                className="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-full transition-colors duration-200"
                            >
                                Connect to Spotify
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-green-900 via-black to-green-900 p-4">
                    <div className="max-w-2xl mx-auto">
                        <div className="bg-gray-900 rounded-lg p-8 shadow-2xl">
                            <div className="flex items-center justify-between mb-8">
                                <div className="flex items-center gap-3">
                                    <div className="w-8 h-8 text-green-500"><Music /></div>
                                    <h1 className="text-2xl font-bold text-white">True Random Shuffler</h1>
                                </div>
                                <button
                                    onClick={handleLogout}
                                    className="text-gray-400 hover:text-white text-sm"
                                >
                                    Disconnect
                                </button>
                            </div>

                            {currentTrack && (
                                <div className="bg-gray-800 rounded-lg p-4 mb-6">
                                    <div className="text-sm text-gray-400 mb-2">Currently Playing</div>
                                    <div className="flex items-center gap-4">
                                        {currentTrack.album?.images?.[0] && (
                                            <img 
                                                src={currentTrack.album.images[0].url} 
                                                alt={currentTrack.album.name}
                                                className="w-16 h-16 rounded"
                                            />
                                        )}
                                        <div>
                                            <div className="text-white font-semibold">{currentTrack.name}</div>
                                            <div className="text-gray-400 text-sm">
                                                {currentTrack.artists?.map(a => a.name).join(', ')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {playlist && (
                                <div className="bg-gray-800 rounded-lg p-4 mb-6">
                                    <div className="text-sm text-gray-400 mb-2">Playlist</div>
                                    <div className="text-white font-semibold">{playlist.name}</div>
                                    <div className="text-gray-400 text-sm">{playlist.tracks.length} tracks</div>
                                </div>
                            )}

                            <button
                                onClick={handleShuffle}
                                disabled={isShuffling}
                                className="w-full bg-green-500 hover:bg-green-600 disabled:bg-gray-600 disabled:cursor-wait text-white font-semibold py-4 px-6 rounded-full transition-colors duration-200 flex items-center justify-center gap-3"
                            >
                                {isShuffling ? (
                                    <>
                                        <div className="animate-spin"><Shuffle /></div>
                                        Shuffling...
                                    </>
                                ) : (
                                    <>
                                        <Shuffle />
                                        Shuffle Current Playlist/Liked Songs
                                    </>
                                )}
                            </button>

                            {status && (
                                <div className="mt-4 p-4 bg-green-900/30 border border-green-600 rounded text-green-200 text-sm">
                                    {status}
                                </div>
                            )}

                            {error && (
                                <div className="mt-4 p-4 bg-red-900/30 border border-red-600 rounded text-red-200 text-sm">
                                    {error}
                                </div>
                            )}

                            <div className="mt-8 text-gray-400 text-sm space-y-2">
                                <p className="font-semibold text-gray-300">How to use:</p>
                                <ol className="list-decimal list-inside space-y-1">
                                    <li>Start playing a playlist or Liked Songs on Spotify</li>
                                    <li>Click "Shuffle Current Playlist/Liked Songs"</li>
                                    <li>All tracks will be added to your queue in truly random order</li>
                                    <li>Skip to the next track to start the shuffled queue</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<SpotifyShuffler />, document.getElementById('root'));
    </script>
</body>
</html>
